# baby-names-webapp

## Development

The `create-local-secret-key.sh` script will need to be run once after you pull down the repo in order to create the JWT secret key in `src/BabyNames/appsettings.secrets.json`.

To build the client (requires Node.js):

```
cd src/BabyNames/Client
yarn install
yarn run build
```

To build the server (requires .NET SDK 6.0 or greater):

```
dotnet build
```

You will also need to create the database by running:

```
./run-database-migrations.sh
```

This will create a `BabyNames.db` file in the root directory.

To run the application:

```
dotnet run
```

The application should be available at http://localhost:8080 and https://localhost:8081.

To run the integration tests you can either run the `run-integration-tests.sh` script or set the `DATABASE__DATABASEFILE` environment variable manually and run them in the IDE of your choice. For Rider, environment variables can be set in File > Settings > Build, Execution, Deployment > Unit Testing > Test Runner.

### TODO

- [x] Create and configure client-side application
- [x] Create and configure server-side application
- [x] Implement API endpoints with dummy data
- [x] Update API to be backed by a database
- [x] Add Redux
- [x] Create skeleton application with planned interactions
- [x] Style application
- [ ] Style login page
- [ ] Add logout page
- [ ] Add animations
- [x] Add auth
- [x] Deployment
- [ ] Add names

## Deployment

### Infrastructure

The following should be added to your Nginx server configuration to setup the reverse proxy:

```
location /baby-names {
        proxy_pass              http://127.0.0.1:5000;
        proxy_http_version      1.1;
        proxy_set_header        Upgrade $http_upgrade;
        proxy_set_header        Connection keep-alive;
        proxy_set_header        Host $host;
        proxy_cache_bypass      $http_upgrade;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header        X-Forwarded-Proto $scheme;
}
```

You should also setup a systemd service so that the application is run automatically. You can do this by copying the `baby-names-webapp.service` file to `/etc/systemd/system`. You will need to replace the `JWT__SECRETKEY` environment variable in this file after copying it. DO NOT use the secret key specified in `launchSettings.json` as it is meant for local development and is not secret. A new secret key can be generated by running the following:

```
openssl rand -base64 32
```

Once the service file is in place run the following to start the service:

```
systemctl enable baby-names-webapp.service
systemctl start baby-names-webapp.service
```

You can check the status of the service:

```
systemctl status baby-names-webapp.service
```

Or view the logs:

```
journalctl -fu baby-names-webapp.service
```

### Deploying Changes

Includes Github Actions that will build the site and archive the result.

To deploy the web application, run the following from the server:

```
wget https://github.com/mattherman/baby-names-webapp/releases/latest/download/server.zip
unzip server.zip -d /var/www/baby-names
systemctl restart baby-names-webapp.service
```

To perform a database migration, run the following from the server:

```
wget https://github.com/mattherman/baby-names-webapp/releases/latest/download/database.zip
unzip database.zip -d ./database
./database/BabyNames.Database execute /var/www/baby-names/BabyNames.db
```
